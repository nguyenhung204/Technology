<%- include('../partials/header', { title: 'Sản phẩm', activeMenu: 'products' }) %>

<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }
    .filter-card {
        background: white;
        border: 1px solid #ddd;
        padding: 20px;
        margin-bottom: 20px;
    }
    .filter-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }
    .form-group {
        margin-bottom: 0;
    }
    label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #555;
        font-size: 13px;
    }
    input, select {
        width: 100%;
        padding: 10px;
        border: 1px solid #000;
        font-size: 14px;
    }
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
    }
    .product-card {
        background: white;
        border: 1px solid #000;
        overflow: hidden;
    }
    .product-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #f0f0f0;
    }
    .product-body {
        padding: 15px;
    }
    .product-name {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
        color: #333;
    }
    .product-price {
        font-size: 20px;
        color: #000;
        font-weight: bold;
        margin-bottom: 8px;
    }
    .product-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-size: 13px;
        color: #666;
    }
    .stock-badge {
        padding: 4px 10px;
        border: 1px solid #000;
        font-size: 12px;
        font-weight: 600;
        background: white;
        color: #000;
    }
    .category-badge {
        background: white;
        color: #000;
        padding: 4px 10px;
        border: 1px solid #000;
        font-size: 12px;
    }
    .product-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
        grid-column: 1 / -1;
    }
    .pagination {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 30px;
    }
    .pagination a, .pagination span {
        padding: 8px 12px;
        border: 1px solid #000;
        text-decoration: none;
        color: #000;
    }
    .pagination a:hover {
        background: #e0e0e0;
    }
    .pagination .active {
        background: #000;
        color: white;
        border-color: #000;
    }
</style>

<div class="page-header">
    <h1>Danh sách sản phẩm</h1>
    <% if (currentUser && currentUser.role === 'admin') { %>
        <a href="/products/create" class="btn btn-primary">Thêm sản phẩm</a>
    <% } %>
</div>

<!-- Filter Form -->
<div class="filter-card">
    <form action="/products" method="GET" class="filter-form">
        <div class="form-group">
            <label for="search">Tìm kiếm:</label>
            <input type="text" id="search" name="search" placeholder="Tên sản phẩm..." value="<%= filters.search || '' %>">
        </div>

        <div class="form-group">
            <label for="categoryId">Danh mục:</label>
            <select id="categoryId" name="categoryId">
                <option value="">Tất cả danh mục</option>
                <% if (categories) { categories.forEach(cat => { %>
                    <option value="<%= cat.id %>" <%= filters.categoryId === cat.id ? 'selected' : '' %>>
                        <%= cat.name %>
                    </option>
                <% })} %>
            </select>
        </div>

        <div class="form-group">
            <label for="minPrice">Giá từ:</label>
            <input type="number" id="minPrice" name="minPrice" placeholder="0" min="0" value="<%= filters.minPrice || '' %>">
        </div>

        <div class="form-group">
            <label for="maxPrice">Giá đến:</label>
            <input type="number" id="maxPrice" name="maxPrice" placeholder="1000000" min="0" value="<%= filters.maxPrice || '' %>">
        </div>

        <div class="form-group">
            <button type="submit" class="btn btn-primary" style="width: 100%;">Tìm kiếm</button>
        </div>

        <% if (filters.search || filters.categoryId || filters.minPrice || filters.maxPrice) { %>
        <div class="form-group">
            <a href="/products" class="btn" style="width: 100%; background: white; color: #000; text-align: center; border: 1px solid #000;">Xóa bộ lọc</a>
        </div>
        <% } %>
    </form>
</div>

<!-- Products Grid -->
<div class="products-grid">
    <% if (products && products.length > 0) { %>
        <% products.forEach(product => { 
            const stockStatus = product.getStockStatus ? product.getStockStatus() : 
                product.quantity <= 0 ? { status: 'out-of-stock', label: 'Hết hàng', class: 'danger' } :
                product.quantity < 5 ? { status: 'low-stock', label: 'Sắp hết', class: 'warning' } :
                { status: 'in-stock', label: 'Còn hàng', class: 'success' };
        %>
            <div class="product-card">
                <% if (product.url_image) { %>
                    <img src="<%= product.url_image %>" alt="<%= product.name %>" class="product-image">
                <% } else { %>
                    <div class="product-image" style="display: flex; align-items: center; justify-content: center; color: #ccc; font-size: 16px; background: #f5f5f5;">
                        No Image
                    </div>
                <% } %>
                
                <div class="product-body">
                    <div class="product-name"><%= product.name %></div>
                    <div class="product-price"><%= product.price.toLocaleString('vi-VN') %>đ</div>
                    
                    <div class="product-info">
                        <span>Số lượng: <strong><%= product.quantity %></strong></span>
                        <span class="stock-badge <%= stockStatus.class %>"><%= stockStatus.label %></span>
                    </div>

                    <% if (product.categoryId && categories) { 
                        const category = categories.find(c => c.id === product.categoryId);
                        if (category) { %>
                            <div style="margin-bottom: 10px;">
                                <span class="category-badge"><%= category.name %></span>
                            </div>
                        <% } %>
                    <% } %>

                    <% if (currentUser && currentUser.role === 'admin') { %>
                        <div class="product-actions">
                            <a href="/products/<%= product.id %>/edit" class="btn btn-primary" style="flex: 1; padding: 8px; text-align: center; font-size: 13px;">Sửa</a>
                            <form action="/products/<%= product.id %>/delete" method="POST" style="flex: 1;" onsubmit="return confirm('Bạn có chắc muốn xóa sản phẩm này?');">
                                <button type="submit" class="btn btn-danger" style="width: 100%; padding: 8px; font-size: 13px;">Xóa</button>
                            </form>
                        </div>
                    <% } %>
                </div>
            </div>
        <% }) %>
    <% } else { %>
        <div class="empty-state">
            <h3>Không tìm thấy sản phẩm nào</h3>
            <p>
                <% if (filters.search || filters.categoryId || filters.minPrice || filters.maxPrice) { %>
                    Thử điều chỉnh bộ lọc hoặc <a href="/products">xóa bộ lọc</a>
                <% } else { %>
                    Hãy thêm sản phẩm đầu tiên
                <% } %>
            </p>
        </div>
    <% } %>
</div>

<!-- Pagination -->
<% if (pagination && pagination.totalPages > 1) { %>
    <div class="pagination">
        <% if (pagination.page > 1) { %>
            <a href="?page=<%= pagination.page - 1 %>&pageSize=<%= pagination.pageSize %><%= filters.search ? '&search=' + filters.search : '' %><%= filters.categoryId ? '&categoryId=' + filters.categoryId : '' %><%= filters.minPrice ? '&minPrice=' + filters.minPrice : '' %><%= filters.maxPrice ? '&maxPrice=' + filters.maxPrice : '' %>">← Trước</a>
        <% } %>

        <% for (let i = 1; i <= pagination.totalPages; i++) { %>
            <% if (i === pagination.page) { %>
                <span class="active"><%= i %></span>
            <% } else { %>
                <a href="?page=<%= i %>&pageSize=<%= pagination.pageSize %><%= filters.search ? '&search=' + filters.search : '' %><%= filters.categoryId ? '&categoryId=' + filters.categoryId : '' %><%= filters.minPrice ? '&minPrice=' + filters.minPrice : '' %><%= filters.maxPrice ? '&maxPrice=' + filters.maxPrice : '' %>"><%= i %></a>
            <% } %>
        <% } %>

        <% if (pagination.page < pagination.totalPages) { %>
            <a href="?page=<%= pagination.page + 1 %>&pageSize=<%= pagination.pageSize %><%= filters.search ? '&search=' + filters.search : '' %><%= filters.categoryId ? '&categoryId=' + filters.categoryId : '' %><%= filters.minPrice ? '&minPrice=' + filters.minPrice : '' %><%= filters.maxPrice ? '&maxPrice=' + filters.maxPrice : '' %>">Sau →</a>
        <% } %>
    </div>
<% } %>

<%- include('../partials/footer') %>
